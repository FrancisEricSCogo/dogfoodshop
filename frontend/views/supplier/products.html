<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Products - Dog Food Shop</title>
    <link rel="icon" type="image/svg+xml" href="../../assets/images/logo.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #334155;
            line-height: 1.6;
            padding-top: 80px;
        }

        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(79,70,229,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.03em;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .product-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            position: relative;
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .product-card:hover {
            box-shadow: 0 12px 48px rgba(79, 70, 229, 0.15);
            transform: translateY(-8px);
        }

        .product-card:hover::before {
            transform: scaleX(1);
        }

        .product-image {
            width: 100%;
            height: 220px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #cbd5e1;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .product-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
            line-height: 1.3;
        }

        .product-description {
            color: #64748b;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            flex-grow: 1;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 10px;
            font-size: 0.85rem;
        }

        .product-stock {
            color: #64748b;
            font-weight: 500;
        }

        .product-stock.in-stock {
            color: #10b981;
            font-weight: 600;
        }

        .product-stock.low-stock {
            color: #f59e0b;
            font-weight: 600;
        }

        .product-stock.out-of-stock {
            color: #ef4444;
            font-weight: 600;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 1rem;
        }

        .product-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: auto;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.4);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
        }

        .form-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .form-container h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1.5rem;
            letter-spacing: -0.015em;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: #ffffff;
            color: #1e293b;
            transition: all 0.3s ease;
            outline: none;
            caret-color: var(--text-dark) !important;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #64748b;
            font-size: 1rem;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.show {
            display: flex;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: capitalize;
            display: inline-block;
        }

        .status-in-stock {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        .status-low-stock {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .status-out-of-stock {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .page-title {
                font-size: 2rem;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    
    <nav class="navbar">
        <div class="container">
            <a href="../guest/index.html" class="logo">Dog Food Shop</a>
            <div class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="products.html" class="active" id="products-link">My Products</a>
                <a href="orders.html">Orders</a>
                <a href="profile.html">Profile</a>
                <span id="userName"></span>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title" id="page-title">My Products</h1>
            <button onclick="showAddProductForm()" class="btn btn-primary">+ Add New Product</button>
        </div>
        
        <div id="add-product-form" style="display: none;" class="form-container">
            <h3>Add New Product</h3>
            <form id="addProductForm">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" name="name" required placeholder="Enter product name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" placeholder="Enter product description"></textarea>
                </div>
                <div class="form-group">
                    <label>Price (‚Ç±)</label>
                    <input type="number" step="0.01" name="price" required placeholder="0.00" min="0">
                </div>
                <div class="form-group">
                    <label>Stock Quantity</label>
                    <input type="number" name="stock" required placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>Product Image (Optional)</label>
                    <input type="file" name="image" id="add-product-image" accept="image/jpeg,image/png,image/gif,image/webp" style="padding: 0.5rem;">
                    <small style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem; display: block;">Max file size: 10MB. Supported formats: JPG, PNG, GIF, WEBP</small>
                    <div id="add-image-preview" style="margin-top: 1rem; display: none;">
                        <img id="add-preview-img" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 10px; border: 2px solid #e2e8f0;">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Product</button>
                    <button type="button" onclick="hideAddProductForm()" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Edit Product Modal -->
        <div id="edit-product-form" style="display: none;" class="form-container">
            <h3>Edit Product</h3>
            <form id="editProductForm">
                <input type="hidden" name="product_id" id="edit-product-id">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" name="name" id="edit-product-name" required placeholder="Enter product name">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" id="edit-product-description" placeholder="Enter product description"></textarea>
                </div>
                <div class="form-group">
                    <label>Price (‚Ç±)</label>
                    <input type="number" step="0.01" name="price" id="edit-product-price" required placeholder="0.00" min="0">
                </div>
                <div class="form-group">
                    <label>Stock Quantity</label>
                    <input type="number" name="stock" id="edit-product-stock" required placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>Product Image (Optional)</label>
                    <input type="file" name="image" id="edit-product-image" accept="image/jpeg,image/png,image/gif,image/webp" style="padding: 0.5rem;">
                    <small style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem; display: block;">Max file size: 10MB. Leave empty to keep current image.</small>
                    <div id="edit-image-preview" style="margin-top: 1rem;">
                        <img id="edit-preview-img" src="" alt="Current Image" style="max-width: 200px; max-height: 200px; border-radius: 10px; border: 2px solid #e2e8f0; display: none;">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Update Product</button>
                    <button type="button" onclick="hideEditProductForm()" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>

        <div id="products-list" class="products-grid">
            <div class="empty-state">
                <div class="empty-state-icon">‚è≥</div>
                <h3>Loading Products...</h3>
                <p>Please wait while we fetch your products</p>
            </div>
        </div>
    </div>

    <!-- View Product Modal -->
    <div id="view-product-modal" class="modal">
        <div class="modal-content" style="background: white; border-radius: 20px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div class="modal-header" style="padding: 2rem; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 1.8rem; font-weight: 700; color: #1e293b; margin: 0;">üëÅÔ∏è Product Details</h3>
                <button class="modal-close" onclick="closeViewProductModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; padding: 0.5rem; line-height: 1;">&times;</button>
            </div>
            <div id="view-product-content" style="padding: 2rem;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-actions" style="padding: 1.5rem 2rem; border-top: 2px solid #e2e8f0; display: flex; justify-content: flex-end;">
                <button type="button" onclick="closeViewProductModal()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/supplier.js"></script>
    <script>
        // Helper function to resolve image paths - use backend API
        function resolveImagePath(imagePath) {
            if (!imagePath) return null;
            
            // If already a full URL, use it
            if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                return imagePath;
            }
            
            // Extract filename from path
            let filename = '';
            if (imagePath.includes('products/')) {
                filename = imagePath.split('products/').pop();
            } else if (imagePath.includes('/')) {
                filename = imagePath.split('/').pop();
            } else {
                filename = imagePath;
            }
            
            // Clean filename
            filename = filename.split('?')[0].split('#')[0];
            
            // Construct URL using backend API
            const apiBase = window.API_BASE || API_BASE || 'https://dogfoodshop.ccs4thyear.com/api';
            return `${apiBase}/storage/products/${filename}`;
        }
        
        // API_BASE is already defined in auth.js, no need to redeclare
        checkAuth();
        
        // Override loadSupplierProducts to use modern design
        async function loadSupplierProductsModern() {
            const user = getUser();
            if (!user) return;
            
            // Diagnostic: Log user info
            console.log('üîç Supplier Diagnostic:', {
                'Your User ID': user.id,
                'Your Username': user.username,
                'Your Role': user.role,
                'API URL': user.role === 'admin' 
                    ? `${API_BASE}/products/get_products.php`
                    : `${API_BASE}/products/get_products.php?supplier_id=${user.id}`
            });
            
            try {
                // Admin should see all products, suppliers see all products (not filtered by supplier_id)
                // This allows users who changed from admin/customer to supplier to see all data
                const url = user.role === 'admin' 
                    ? `${API_BASE}/products/get_products.php`
                    : `${API_BASE}/products/get_products.php?supplier_id=${user.id}`;
                
                // Send auth token so backend knows user is authenticated supplier
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                // Diagnostic: Log API response
                console.log('üì¶ Products API Response:', {
                    'Success': data.success,
                    'Product Count': data.products ? data.products.length : 0,
                    'Products': data.products ? data.products.map(p => ({ id: p.id, name: p.name, supplier_id: p.supplier_id })) : []
                });
                
                const list = document.getElementById('products-list');
                
                if (data.success) {
                    if (data.products.length === 0) {
                        const emptyMessage = user.role === 'admin' 
                            ? '<h3>No Products in System</h3><p>No products have been added yet.</p>'
                            : '<h3>No Products Yet</h3><p>Start by adding your first product!</p>';
                        
                        list.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üêï</div>
                                ${emptyMessage}
                            </div>
                        `;
                        return;
                    }
                    
                    list.innerHTML = data.products.map((product, index) => {
                        const stockClass = product.stock === 0 ? 'out-of-stock' : 
                                          product.stock < 10 ? 'low-stock' : 'in-stock';
                        const stockText = product.stock === 0 ? 'Out of Stock' : 
                                         product.stock < 10 ? `Low Stock (${product.stock})` : 
                                         `In Stock (${product.stock})`;
                        
                        // Fix image loading with proper fallback
                        let imageHtml = 'üêï';
                        if (product.image) {
                            const imageSrc = resolveImagePath(product.image);
                            if (imageSrc) {
                                imageHtml = `<img src="${imageSrc}" alt="${product.name}" onerror="this.parentElement.innerHTML='üêï'">`;
                            }
                        }
                        
                        const supplierInfo = user.role === 'admin' && product.supplier_name 
                            ? `<div class="product-supplier" style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">Supplier: ${product.supplier_name}</div>`
                            : '';
                        
                        return `
                            <div class="product-card" style="animation-delay: ${index * 0.1}s">
                                <div class="product-image">
                                    ${imageHtml}
                                </div>
                                <div class="product-info">
                                    <h3 class="product-title">${product.name}</h3>
                                    <p class="product-description">${product.description || 'Premium quality dog food for your pet.'}</p>
                                    <div class="product-meta">
                                        <span class="product-stock ${stockClass}">${stockText}</span>
                                    </div>
                                    ${supplierInfo}
                                    <div class="product-price">‚Ç±${parseFloat(product.price).toFixed(2)}</div>
                                    <div class="product-actions">
                                        <button onclick="viewProduct(${product.id})" class="btn" style="background: #f1f5f9; color: #64748b;">üëÅÔ∏è View</button>
                                        <button onclick="editProduct(${product.id})" class="btn btn-primary">Edit</button>
                                        <button onclick="deleteProduct(${product.id})" class="btn btn-danger">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <h3>Error Loading Products</h3>
                            <p>${data.error || 'Please try again later'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>Error Loading Products</h3>
                        <p>Please refresh the page and try again</p>
                    </div>
                `;
            }
        }
        
        // Override the original function
        loadSupplierProducts = loadSupplierProductsModern;
        
        // Load products on page load
        loadSupplierProducts();
        
        // Image preview for add form
        document.getElementById('add-product-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('add-preview-img').src = e.target.result;
                    document.getElementById('add-image-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('add-image-preview').style.display = 'none';
            }
        });

        // Handle add product form with file upload
        // Check if listener already attached to prevent duplicates
        const addProductForm = document.getElementById('addProductForm');
        if (addProductForm && !addProductForm.hasAttribute('data-listener-attached')) {
            addProductForm.setAttribute('data-listener-attached', 'true');
            
            addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const imageFile = formData.get('image');
            
            let imagePath = '';
            
            // Upload image if provided
            if (imageFile && imageFile.size > 0) {
                try {
                    const uploadFormData = new FormData();
                    uploadFormData.append('image', imageFile);
                    
                    const token = getToken();
                    const uploadResponse = await fetch(`${API_BASE}/products/upload_image.php`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                            // Don't set Content-Type for FormData - browser will set it with boundary
                        },
                        body: uploadFormData
                    });
                    
                    const uploadResult = await uploadResponse.json();
                    
                    if (uploadResult.success) {
                        // Store the relative path in database, not the full URL
                        imagePath = uploadResult.image_path || uploadResult.image_url;
                    } else {
                        alert('Error uploading image: ' + uploadResult.error);
                        return;
                    }
                } catch (error) {
                    alert('Failed to upload image');
                    return;
                }
            }
            
            // Prevent double submission - disable submit button
            const submitBtn = e.target.querySelector('button[type="submit"]');
            if (submitBtn.disabled) {
                return; // Already submitting, prevent double submission
            }
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            
            // Create product
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                stock: parseInt(formData.get('stock')),
                image: imagePath
            };
            
            try {
                const response = await fetch(`${API_BASE}/products/add_product.php`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Product added successfully!',
                        confirmButtonColor: '#667eea',
                        timer: 2000,
                        showConfirmButton: true
                    });
                    hideAddProductForm();
                    loadSupplierProducts();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.error || 'Failed to add product',
                        confirmButtonColor: '#667eea'
                    });
                    // Re-enable button on error
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to add product: ' + error.message,
                    confirmButtonColor: '#667eea'
                });
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
            });
        }

        // Edit product function
        async function editProduct(productId) {
            try {
                const response = await fetch(`${API_BASE}/products/get_product.php?id=${productId}`);
                const data = await response.json();
                
                if (data.success && data.product) {
                    const product = data.product;
                    
                    // Populate edit form
                    document.getElementById('edit-product-id').value = product.id;
                    document.getElementById('edit-product-name').value = product.name;
                    document.getElementById('edit-product-description').value = product.description || '';
                    document.getElementById('edit-product-price').value = product.price;
                    document.getElementById('edit-product-stock').value = product.stock;
                    
                    // Show current image if exists
                    const previewImg = document.getElementById('edit-preview-img');
                    if (product.image) {
                        const imageSrc = resolveImagePath(product.image);
                        if (imageSrc) {
                            previewImg.src = imageSrc;
                            previewImg.style.display = 'block';
                        } else {
                            previewImg.style.display = 'none';
                        }
                    } else {
                        previewImg.style.display = 'none';
                    }
                    
                    // Show edit form
                    document.getElementById('edit-product-form').style.display = 'block';
                    document.getElementById('add-product-form').style.display = 'none';
                    
                    // Scroll to edit form
                    document.getElementById('edit-product-form').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    alert('Error loading product details');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Failed to load product details');
            }
        }

        function hideEditProductForm() {
            document.getElementById('edit-product-form').style.display = 'none';
            document.getElementById('editProductForm').reset();
            document.getElementById('edit-preview-img').style.display = 'none';
        }

        // Image preview for edit form
        document.getElementById('edit-product-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-preview-img').src = e.target.result;
                    document.getElementById('edit-preview-img').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle edit product form with file upload
        document.getElementById('editProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productId = formData.get('product_id');
            const imageFile = formData.get('image');
            
            let imagePath = null; // null means don't update image
            
            // Upload new image if provided
            if (imageFile && imageFile.size > 0) {
                try {
                    const uploadFormData = new FormData();
                    uploadFormData.append('image', imageFile);
                    
                    const token = getToken();
                    const uploadResponse = await fetch(`${API_BASE}/products/upload_image.php`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                            // Don't set Content-Type for FormData - browser will set it with boundary
                        },
                        body: uploadFormData
                    });
                    
                    const uploadResult = await uploadResponse.json();
                    
                    if (uploadResult.success) {
                        // Store the relative path in database, not the full URL
                        imagePath = uploadResult.image_path || uploadResult.image_url;
                    } else {
                        alert('Error uploading image: ' + uploadResult.error);
                        return;
                    }
                } catch (error) {
                    alert('Failed to upload image');
                    return;
                }
            }
            
            // Update product
            const data = {
                product_id: parseInt(productId),
                name: formData.get('name'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                stock: parseInt(formData.get('stock'))
            };
            
            // Only include image if a new one was uploaded
            if (imagePath !== null) {
                data.image = imagePath;
            }
            
            try {
                const response = await fetch(`${API_BASE}/products/update_product.php`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Product updated successfully!');
                    hideEditProductForm();
                    loadSupplierProducts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Failed to update product');
            }
        });

        // View product function
        async function viewProduct(productId) {
            try {
                const response = await fetch(`${API_BASE}/products/get_product.php?id=${productId}`);
                const data = await response.json();
                
                if (data.success && data.product) {
                    const product = data.product;
                    const imageSrc = product.image ? resolveImagePath(product.image) : null;
                    const stockClass = product.stock === 0 ? 'out-of-stock' : 
                                      product.stock < 10 ? 'low-stock' : 'in-stock';
                    const stockText = product.stock === 0 ? 'Out of Stock' : 
                                     product.stock < 10 ? `Low Stock (${product.stock})` : 
                                     `In Stock (${product.stock})`;
                    
                    const createdDate = new Date(product.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const updatedDate = product.updated_at ? new Date(product.updated_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'Never';
                    
                    const content = `
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 2rem;">
                            <div style="background: #f8fafc; border-radius: 12px; padding: 1.5rem; display: flex; align-items: center; justify-content: center; min-height: 250px;">
                                ${imageSrc ? `<img src="${imageSrc}" alt="${product.name}" style="max-width: 100%; max-height: 250px; border-radius: 10px; object-fit: contain;" onerror="this.parentElement.innerHTML='üêï'">` : '<div style="font-size: 4rem;">üêï</div>'}
                            </div>
                            <div>
                                <h2 style="font-size: 1.8rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem;">${product.name}</h2>
                                <div style="font-size: 2rem; font-weight: 700; color: #4f46e5; margin-bottom: 1rem;">‚Ç±${parseFloat(product.price).toFixed(2)}</div>
                                <div style="margin-bottom: 1rem;">
                                    <span class="status-badge status-${stockClass}" style="padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; display: inline-block;">
                                        ${stockText}
                                    </span>
                                </div>
                                ${product.supplier_name ? `<div style="color: #64748b; font-size: 0.95rem; margin-bottom: 1rem;"><strong>Supplier:</strong> ${product.supplier_name}</div>` : ''}
                            </div>
                        </div>
                        <div style="border-top: 2px solid #e2e8f0; padding-top: 1.5rem; margin-top: 1.5rem;">
                            <h3 style="font-size: 1.2rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">Description</h3>
                            <p style="color: #64748b; line-height: 1.6; margin-bottom: 1.5rem;">${product.description || 'No description available.'}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e2e8f0;">
                            <div>
                                <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem;">Product ID</div>
                                <div style="font-weight: 600; color: #1e293b;">#${product.id}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem;">Stock Quantity</div>
                                <div style="font-weight: 600; color: #1e293b;">${product.stock} units</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem;">Created Date</div>
                                <div style="font-weight: 600; color: #1e293b;">${createdDate}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.5rem;">Last Updated</div>
                                <div style="font-weight: 600; color: #1e293b;">${updatedDate}</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('view-product-content').innerHTML = content;
                    document.getElementById('view-product-modal').style.display = 'flex';
                    document.getElementById('view-product-modal').classList.add('show');
                } else {
                    alert('Failed to load product details.');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Error loading product details.');
            }
        }

        function closeViewProductModal() {
            document.getElementById('view-product-modal').style.display = 'none';
            document.getElementById('view-product-modal').classList.remove('show');
        }

        // Add delete product function
        async function deleteProduct(productId) {
            // Get product name for confirmation
            let productName = 'this product';
            try {
                const productResponse = await fetch(`${API_BASE}/products/get_product.php?id=${productId}`);
                const productData = await productResponse.json();
                if (productData.success && productData.product) {
                    productName = productData.product.name;
                }
            } catch (error) {
                console.error('Error fetching product name:', error);
            }
            
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: `Do you want to delete "${productName}"? This action cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true
            });
            
            if (!result.isConfirmed) {
                return;
            }
            
            // Show loading
            Swal.fire({
                title: 'Deleting...',
                text: 'Please wait',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                const response = await fetch(`${API_BASE}/products/delete_product.php?id=${productId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const deleteResult = await response.json();
                
                if (deleteResult.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: 'Product deleted successfully!',
                        confirmButtonColor: '#667eea',
                        timer: 2000,
                        showConfirmButton: true
                    });
                    loadSupplierProducts();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: deleteResult.error || 'Failed to delete product',
                        confirmButtonColor: '#667eea'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to delete product: ' + error.message,
                    confirmButtonColor: '#667eea'
                });
            }
        }

        // Check user role and adjust page for admin
        function checkUserRole() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const productsLink = document.getElementById('products-link');
            const pageTitle = document.getElementById('page-title');
            
            if (user.role === 'admin') {
                if (productsLink) {
                    productsLink.textContent = 'Products';
                }
                if (pageTitle) {
                    pageTitle.textContent = 'Products Management';
                }
            }
        }

        // Call on page load
        checkUserRole();
    </script>
</body>
</html>
